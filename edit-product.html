<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>iBlue | Edit Product</title>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ===== MOBILE-FIRST RESET ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #003cff;
      --primary-dark: #0028cc;
      --primary-light: rgba(0, 60, 255, 0.1);
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --dark: #343a40;
      --gray: #6c757d;
      --light: #f8f9fa;
      --border: #dee2e6;
      --shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    html {
      font-size: 14px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: 0;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== TOUCH-FRIENDLY ELEMENTS ===== */
    button,
    input,
    select,
    textarea,
    .btn,
    .action-btn {
      min-height: 44px;
      min-width: 44px;
      touch-action: manipulation;
    }

    /* ===== MOBILE HEADER & NAVIGATION ===== */
    .mobile-header {
      background: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      padding: 0 15px;
      padding-top: var(--safe-area-top);
      height: calc(60px + var(--safe-area-top));
    }

    .mobile-header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--primary);
      font-weight: 800;
      font-size: 1.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .mobile-header .logo i {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mobile-menu-toggle {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--dark);
      cursor: pointer;
      padding: 8px;
    }

    /* ===== MOBILE SIDEBAR ===== */
    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: -280px;
      width: 100%;
      max-width: 280px;
      height: 100vh;
      height: -webkit-fill-available;
      background: white;
      z-index: 2000;
      padding: calc(80px + var(--safe-area-top)) 20px 20px;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 5px 0 20px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .mobile-sidebar.active {
      transform: translateX(280px);
    }

    .mobile-nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mobile-nav .nav-link {
      color: var(--dark);
      background: var(--light);
      padding: 15px;
      border-radius: 10px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .mobile-nav .nav-link:hover,
    .mobile-nav .nav-link.active {
      background: var(--primary);
      color: white;
      transform: translateX(5px);
    }

    .mobile-nav .nav-link i {
      width: 20px;
      text-align: center;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
      display: none;
      backdrop-filter: blur(2px);
    }

    .overlay.active {
      display: block;
    }

    /* ===== ADMIN CONTAINER ===== */
    .admin-container {
      width: 100%;
      background: white;
      overflow: hidden;
      box-shadow: var(--shadow);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
      margin-top: calc(60px + var(--safe-area-top));
      border-radius: 0;
    }

    /* ===== CONTENT WRAPPER ===== */
    .content-wrapper {
      flex: 1;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ===== PAGE HEADER ===== */
    .page-header {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    @media (min-width: 576px) {
      .page-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .page-title h1 {
      color: var(--dark);
      font-size: 1.5rem;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-title h1 i {
      color: var(--primary);
    }

    .page-title p {
      color: var(--gray);
      font-size: 0.9rem;
    }

    /* ===== FORM STYLES ===== */
    .form-container {
      background: white;
      border-radius: var(--radius);
      padding: 25px 20px;
      box-shadow: var(--shadow);
    }

    .form-section {
      margin-bottom: 30px;
    }

    .form-section-title {
      font-size: 1.2rem;
      color: var(--dark);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-section-title i {
      color: var(--primary);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .form-row {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.95rem;
    }

    .form-label.required::after {
      content: " *";
      color: var(--danger);
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 14px 15px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      background: white;
      transition: all 0.3s;
      font-family: inherit;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-help {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 6px;
    }

    /* ===== CHECKBOX AND SWITCH STYLES ===== */
    .form-check {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      cursor: pointer;
    }

    .form-check-input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .form-check-label {
      font-weight: 500;
      color: var(--dark);
      cursor: pointer;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--success);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* ===== IMAGE UPLOAD STYLES ===== */
    .image-upload-container {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 30px 20px;
      text-align: center;
      background: var(--light);
      cursor: pointer;
      transition: all 0.3s;
    }

    .image-upload-container:hover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .image-upload-icon {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 15px;
    }

    .image-upload-text {
      color: var(--gray);
      margin-bottom: 10px;
    }

    .image-upload-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: inline-block;
      transition: all 0.3s;
    }

    .image-upload-btn:hover {
      background: var(--primary-dark);
    }

    .image-preview-container {
      margin-top: 20px;
    }

    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
      margin-top: 15px;
    }

    .image-preview {
      position: relative;
      width: 100%;
      padding-bottom: 100%;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--border);
    }

    .image-preview img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--danger);
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.8rem;
    }

    /* ===== ACTION BUTTONS ===== */
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      text-decoration: none;
    }

    .action-btn:active {
      transform: scale(0.98);
    }

    .btn-save {
      background: var(--success);
      color: white;
    }

    .btn-save:hover {
      background: #218838;
    }

    .btn-cancel {
      background: var(--light);
      color: var(--dark);
      border: 2px solid var(--border);
    }

    .btn-cancel:hover {
      background: #e2e6ea;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
    }

    .btn-delete:hover {
      background: #c82333;
    }

    /* ===== LOADING STATE ===== */
    .loading {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 60, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== TOAST MESSAGES ===== */
    .status-message {
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      max-width: 400px;
      margin-left: auto;
      margin-right: 20px;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 4000;
    }
    
    .status-message.success {
      border-left: 4px solid var(--success);
      color: var(--success);
    }
    
    .status-message.error {
      border-left: 4px solid var(--danger);
      color: var(--danger);
    }

    /* ===== BOTTOM NAVIGATION ===== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid var(--border);
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-around;
      padding-bottom: calc(10px + var(--safe-area-bottom));
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: var(--gray);
      font-size: 0.75rem;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s;
      min-height: 44px;
      justify-content: center;
    }

    .bottom-nav-item.active {
      color: var(--primary);
      background: var(--primary-light);
    }

    .bottom-nav-item i {
      font-size: 1.2rem;
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */
    @media (min-width: 480px) {
      html {
        font-size: 15px;
      }
      
      .admin-container {
        border-radius: 12px;
        margin: 20px auto;
        max-width: 100%;
        width: calc(100% - 20px);
        margin-top: calc(80px + var(--safe-area-top));
      }
      
      .content-wrapper {
        padding: 25px 20px;
      }
    }

    @media (min-width: 768px) {
      .mobile-header {
        display: none;
      }
      
      .mobile-sidebar,
      .overlay {
        display: none !important;
      }
      
      .admin-container {
        margin: 30px auto;
        max-width: 800px;
        margin-top: 30px;
      }
      
      .content-wrapper {
        padding: 30px;
      }
      
      .bottom-nav {
        display: none;
      }
    }

    /* ===== MODAL STYLES ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      padding: 20px;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 1.3rem;
      color: var(--dark);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--dark);
    }
  </style>
</head>
<body>
  <!-- Mobile Header -->
  <header class="mobile-header">
    <a href="products.html" class="logo">
      <i class="fas fa-arrow-left"></i>
      <span>Edit Product</span>
    </a>
    <div class="header-actions">
      <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Menu">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Mobile Sidebar -->
  <nav class="mobile-sidebar" id="mobileSidebar">
    <div class="mobile-nav">
      <a href="dashboard.html" class="nav-link">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </a>
      <a href="add-product.html" class="nav-link">
        <i class="fas fa-plus-circle"></i> Add Product
      </a>
      <a href="products.html" class="nav-link">
        <i class="fas fa-boxes"></i> Manage Products
      </a>
      <a href="categories.html" class="nav-link">
        <i class="fas fa-tags"></i> Categories
      </a>
      <a href="inventory.html" class="nav-link">
        <i class="fas fa-warehouse"></i> Inventory
      </a>
      <a href="#" onclick="logout()" class="nav-link">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </nav>
  <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

  <!-- Bottom Navigation for Mobile -->
  <div class="bottom-nav">
    <a href="dashboard.html" class="bottom-nav-item">
      <i class="fas fa-tachometer-alt"></i>
      <span>Dashboard</span>
    </a>
    <a href="add-product.html" class="bottom-nav-item">
      <i class="fas fa-plus-circle"></i>
      <span>Add</span>
    </a>
    <a href="products.html" class="bottom-nav-item">
      <i class="fas fa-boxes"></i>
      <span>Products</span>
    </a>
    <a href="orders.html" class="bottom-nav-item">
      <i class="fas fa-shopping-cart"></i>
      <span>Orders</span>
    </a>
  </div>

  <!-- Admin Container -->
  <main class="admin-container">
    <div class="content-wrapper">
      <!-- Page Header -->
      <div class="page-header">
        <div class="page-title">
          <h1><i class="fas fa-edit"></i> Edit Product</h1>
          <p>Update product details and settings</p>
        </div>
      </div>

      <!-- Loading State -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Loading product data...</span>
      </div>

      <!-- Product Form -->
      <form id="editProductForm" class="form-container" style="display: none;">
        <!-- Basic Information -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-info-circle"></i> Basic Information
          </h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="productName" class="form-label required">Product Name</label>
              <input type="text" id="productName" class="form-input" required>
              <div class="form-help">Enter the full name of the product</div>
            </div>
            
            <div class="form-group">
              <label for="productSku" class="form-label required">SKU</label>
              <input type="text" id="productSku" class="form-input" required>
              <div class="form-help">Stock Keeping Unit (unique identifier)</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="productDescription" class="form-label">Description</label>
            <textarea id="productDescription" class="form-textarea" rows="4"></textarea>
            <div class="form-help">Detailed description of the product</div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-tag"></i> Pricing
          </h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="productPrice" class="form-label required">Price (UGX)</label>
              <input type="number" id="productPrice" class="form-input" min="0" step="0.01" required>
              <div class="form-help">Current selling price</div>
            </div>
            
            <div class="form-group">
              <label for="productDiscountPrice" class="form-label">Discount Price (UGX)</label>
              <input type="number" id="productDiscountPrice" class="form-input" min="0" step="0.01">
              <div class="form-help">Discounted price (if on sale)</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="productWeight" class="form-label">Weight (kg)</label>
              <input type="number" id="productWeight" class="form-input" step="0.01" min="0">
              <div class="form-help">Product weight in kilograms</div>
            </div>
            
            <div class="form-group">
              <label for="productDimensions" class="form-label">Dimensions (L×W×H)</label>
              <input type="text" id="productDimensions" class="form-input" placeholder="e.g., 10×5×3">
              <div class="form-help">Product dimensions in centimeters</div>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-warehouse"></i> Inventory
          </h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="productStock" class="form-label required">Stock Quantity</label>
              <input type="number" id="productStock" class="form-input" min="0" required>
              <div class="form-help">Number of items available in stock</div>
            </div>
            
            <div class="form-group">
              <label for="productCategory" class="form-label required">Category</label>
              <select id="productCategory" class="form-select" required>
                <option value="">Select Category</option>
                <!-- Categories will be populated dynamically -->
              </select>
              <div class="form-help">Select product category</div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="productBrand" class="form-label">Brand</label>
              <input type="text" id="productBrand" class="form-input">
              <div class="form-help">Product brand or manufacturer</div>
            </div>
            
            <div class="form-group">
              <label for="productColor" class="form-label">Color</label>
              <input type="text" id="productColor" class="form-input">
              <div class="form-help">Main color of the product</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="productMaterial" class="form-label">Material</label>
            <input type="text" id="productMaterial" class="form-input">
            <div class="form-help">Main material of the product</div>
          </div>
        </div>

        <!-- Images -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-images"></i> Product Images
          </h2>
          
          <div class="image-upload-container" onclick="document.getElementById('imageUpload').click()">
            <div class="image-upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <div class="image-upload-text">
              <strong>Click to upload images</strong>
            </div>
            <div class="form-help">Supported formats: JPG, PNG, GIF, WEBP (Max 5MB)</div>
            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;" onchange="handleImageUpload()">
          </div>
          
          <div class="image-preview-container" id="imagePreviewContainer">
            <label class="form-label">Current Images</label>
            <div class="image-preview-grid" id="imagePreviewGrid">
              <!-- Existing images will be shown here -->
            </div>
          </div>
          
          <div class="form-help">First image will be used as the main product image</div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-info-circle"></i> Additional Information
          </h2>
          
          <div class="form-group">
            <label for="productVideo" class="form-label">Video Demo URL</label>
            <input type="url" id="productVideo" class="form-input" placeholder="https://">
            <div class="form-help">URL to product demonstration video (YouTube, Vimeo, etc.)</div>
          </div>
        </div>

        <!-- Settings -->
        <div class="form-section">
          <h2 class="form-section-title">
            <i class="fas fa-cog"></i> Settings
          </h2>
          
          <div class="form-check">
            <input type="checkbox" id="productActive" class="form-check-input" checked>
            <label for="productActive" class="form-check-label">Active (visible to customers)</label>
          </div>
          
          <div class="form-check">
            <input type="checkbox" id="productFeatured" class="form-check-input">
            <label for="productFeatured" class="form-check-label">Featured Product</label>
          </div>
          
          <div class="form-check">
            <input type="checkbox" id="productDeal" class="form-check-input">
            <label for="productDeal" class="form-check-label">Special Deal</label>
          </div>
          
          <div class="form-check">
            <input type="checkbox" id="productFreeShipping" class="form-check-input">
            <label for="productFreeShipping" class="form-check-label">Free Shipping</label>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button type="submit" class="action-btn btn-save">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <a href="products.html" class="action-btn btn-cancel">
            <i class="fas fa-times"></i> Cancel
          </a>
          <button type="button" class="action-btn btn-delete" onclick="showDeleteModal()">
            <i class="fas fa-trash"></i> Delete Product
          </button>
        </div>
      </form>
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="deleteMessage">Are you sure you want to delete this product? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="action-btn btn-cancel" onclick="closeModal('deleteModal')">Cancel</button>
        <button class="action-btn btn-delete" onclick="deleteProduct()">Delete Product</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize Supabase client
    const SUPABASE_URL = "https://amxhpxqakqrjjihwkzcq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFteGhweHFha3FyamppaHdremNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5Nzc2NjUsImV4cCI6MjA4MzU1MzY2NX0.yIAZtz3bUc_ZxF8-f4cqW1fKJgFiRsiJdj4qgCDmM0g";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Global variables
    let currentProductId = null;
    let productImages = [];
    let existingImages = [];

    // DOM Elements
    const loading = document.getElementById('loading');
    const editProductForm = document.getElementById('editProductForm');
    const deleteModal = document.getElementById('deleteModal');
    const deleteMessage = document.getElementById('deleteMessage');

    // Get product ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    currentProductId = urlParams.get('id');

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      if (!currentProductId) {
        showMessage('No product selected. Redirecting...', 'error');
        setTimeout(() => {
          window.location.href = 'products.html';
        }, 2000);
        return;
      }
      
      // Check authentication
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      
      await loadProductData();
      await loadCategories();
    });

    // Load product data from Supabase
    async function loadProductData() {
      loading.classList.add('active');
      
      try {
        // FIXED: Changed from 'products' to 'products_new' to match schema
        const { data, error } = await sb
          .from('products_new')
          .select('*')
          .eq('id', currentProductId)
          .single();
        
        if (error) throw error;
        
        if (!data) {
          throw new Error('Product not found');
        }
        
        console.log('Product data loaded:', data);
        
        // Populate form fields
        document.getElementById('productName').value = data.name || '';
        document.getElementById('productSku').value = data.sku || '';
        document.getElementById('productDescription').value = data.description || '';
        document.getElementById('productPrice').value = data.price || 0;
        document.getElementById('productDiscountPrice').value = data.discount_price || '';
        document.getElementById('productStock').value = data.stock_quantity || 0;
        document.getElementById('productBrand').value = data.brand || '';
        document.getElementById('productWeight').value = data.weight || '';
        document.getElementById('productDimensions').value = data.dimensions || '';
        document.getElementById('productColor').value = data.color || '';
        document.getElementById('productMaterial').value = data.material || '';
        document.getElementById('productVideo').value = data.video_demo_url || '';
        
        // Handle boolean fields
        document.getElementById('productActive').checked = data.is_active !== false;
        document.getElementById('productFeatured').checked = data.featured || false;
        document.getElementById('productDeal').checked = data.is_deal || false;
        document.getElementById('productFreeShipping').checked = data.free_shipping || false;
        
        // Handle category selection
        const categorySelect = document.getElementById('productCategory');
        if (data.category) {
          categorySelect.value = data.category;
        }
        
        // Handle images - products_new has 'images' (jsonb) field
        if (data.images && Array.isArray(data.images) && data.images.length > 0) {
          existingImages = data.images;
          displayExistingImages();
        }
        
        // Show form
        editProductForm.style.display = 'block';
        
      } catch (error) {
        console.error('Error loading product:', error);
        showMessage(`Error loading product: ${error.message}`, 'error');
        setTimeout(() => {
          window.location.href = 'products.html';
        }, 3000);
      } finally {
        loading.classList.remove('active');
      }
    }

    // Load categories for dropdown
    async function loadCategories() {
      try {
        const { data, error } = await sb
          .from('categories')
          .select('id, name, slug')
          .eq('is_active', true)
          .order('name');
        
        if (error) throw error;
        
        const categorySelect = document.getElementById('productCategory');
        
        data.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Error loading categories:', error);
        showMessage('Error loading categories', 'error');
      }
    }

    // Display existing images
    function displayExistingImages() {
      const imagePreviewGrid = document.getElementById('imagePreviewGrid');
      imagePreviewGrid.innerHTML = '';
      
      if (existingImages.length === 0) {
        document.getElementById('imagePreviewContainer').style.display = 'none';
        return;
      }
      
      document.getElementById('imagePreviewContainer').style.display = 'block';
      
      existingImages.forEach((imageUrl, index) => {
        const imagePreview = document.createElement('div');
        imagePreview.className = 'image-preview';
        imagePreview.innerHTML = `
          <img src="${imageUrl}" alt="Product image ${index + 1}" onerror="this.src='https://via.placeholder.com/100'">
          <button type="button" class="image-remove" onclick="removeExistingImage(${index})">
            <i class="fas fa-times"></i>
          </button>
        `;
        imagePreviewGrid.appendChild(imagePreview);
      });
    }

    // Handle new image upload
    async function handleImageUpload() {
      const files = document.getElementById('imageUpload').files;
      
      if (files.length > 0) {
        for (const file of files) {
          if (file.size > 5 * 1024 * 1024) {
            showMessage(`File ${file.name} is too large. Max 5MB allowed.`, 'error');
            continue;
          }
          
          try {
            // Generate unique filename
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
            const filePath = `product-images/${currentProductId}/${fileName}`;
            
            // Upload to Supabase Storage
            const { data, error } = await sb.storage
              .from('product-images')
              .upload(filePath, file);
            
            if (error) throw error;
            
            // Get public URL
            const { data: { publicUrl } } = sb.storage
              .from('product-images')
              .getPublicUrl(filePath);
            
            productImages.push(publicUrl);
            updateImagePreview();
            
          } catch (error) {
            console.error('Error uploading image:', error);
            showMessage(`Error uploading ${file.name}: ${error.message}`, 'error');
          }
        }
        
        // Reset file input
        document.getElementById('imageUpload').value = '';
      }
    }

    // Update image preview with new uploads
    function updateImagePreview() {
      const imagePreviewGrid = document.getElementById('imagePreviewGrid');
      document.getElementById('imagePreviewContainer').style.display = 'block';
      
      // Display all images (existing + new)
      const allImages = [...existingImages, ...productImages];
      
      if (allImages.length === 0) {
        document.getElementById('imagePreviewContainer').style.display = 'none';
        return;
      }
      
      imagePreviewGrid.innerHTML = '';
      
      allImages.forEach((imageUrl, index) => {
        const imagePreview = document.createElement('div');
        imagePreview.className = 'image-preview';
        
        if (index < existingImages.length) {
          // Existing image
          imagePreview.innerHTML = `
            <img src="${imageUrl}" alt="Product image ${index + 1}" onerror="this.src='https://via.placeholder.com/100'">
            <button type="button" class="image-remove" onclick="removeExistingImage(${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
        } else {
          // New image
          const newIndex = index - existingImages.length;
          imagePreview.innerHTML = `
            <img src="${imageUrl}" alt="New image ${newIndex + 1}">
            <button type="button" class="image-remove" onclick="removeNewImage(${newIndex})">
              <i class="fas fa-times"></i>
            </button>
          `;
        }
        
        imagePreviewGrid.appendChild(imagePreview);
      });
    }

    // Remove existing image
    async function removeExistingImage(index) {
      if (confirm('Are you sure you want to remove this image?')) {
        const imageUrl = existingImages[index];
        
        try {
          // Extract filename from URL and delete from storage
          const urlParts = imageUrl.split('/');
          const filename = urlParts[urlParts.length - 1];
          const filePath = `product-images/${currentProductId}/${filename}`;
          
          await sb.storage
            .from('product-images')
            .remove([filePath]);
          
          existingImages.splice(index, 1);
          updateImagePreview();
          
        } catch (error) {
          console.error('Error deleting image:', error);
          showMessage('Error removing image from storage', 'error');
        }
      }
    }

    // Remove new image (not yet uploaded)
    function removeNewImage(index) {
      productImages.splice(index, 1);
      updateImagePreview();
    }

    // Validate product data
    function validateProductData(data) {
      const errors = [];
      
      if (!data.name || data.name.trim().length < 2) {
        errors.push('Product name must be at least 2 characters');
      }
      
      if (!data.sku || data.sku.trim().length < 3) {
        errors.push('SKU must be at least 3 characters');
      }
      
      if (!data.price || data.price <= 0) {
        errors.push('Price must be greater than 0');
      }
      
      if (data.stock_quantity < 0) {
        errors.push('Stock quantity cannot be negative');
      }
      
      if (data.discount_price && data.discount_price >= data.price) {
        errors.push('Discount price must be less than regular price');
      }
      
      if (data.weight && data.weight < 0) {
        errors.push('Weight cannot be negative');
      }
      
      return errors;
    }

    // Handle form submission
    editProductForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Get form values - FIXED to match products_new schema
      const productData = {
        name: document.getElementById('productName').value.trim(),
        sku: document.getElementById('productSku').value.trim(),
        description: document.getElementById('productDescription').value.trim(),
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        discount_price: document.getElementById('productDiscountPrice').value ? 
          parseFloat(document.getElementById('productDiscountPrice').value) : null,
        stock_quantity: parseInt(document.getElementById('productStock').value) || 0,
        category: document.getElementById('productCategory').value, // products_new has 'category' not 'category_id'
        brand: document.getElementById('productBrand').value.trim() || null,
        weight: document.getElementById('productWeight').value ? 
          parseFloat(document.getElementById('productWeight').value) : null,
        dimensions: document.getElementById('productDimensions').value.trim() || null,
        color: document.getElementById('productColor').value.trim() || null,
        material: document.getElementById('productMaterial').value.trim() || null,
        video_demo_url: document.getElementById('productVideo').value.trim() || null,
        is_active: document.getElementById('productActive').checked,
        featured: document.getElementById('productFeatured').checked,
        is_deal: document.getElementById('productDeal').checked,
        free_shipping: document.getElementById('productFreeShipping').checked,
        updated_at: new Date().toISOString()
      };
      
      // Validate product data
      const validationErrors = validateProductData(productData);
      if (validationErrors.length > 0) {
        showMessage(validationErrors.join('. '), 'error');
        return;
      }
      
      // Handle images - FIXED: products_new has 'images' (jsonb) field
      const allImages = [...existingImages, ...productImages];
      if (allImages.length > 0) {
        productData.images = allImages;
      } else {
        productData.images = null;
      }
      
      // Save to Supabase - FIXED: Update products_new table
      try {
        const { error } = await sb
          .from('products_new')
          .update(productData)
          .eq('id', currentProductId);
        
        if (error) throw error;
        
        showMessage('Product updated successfully!', 'success');
        
        // Redirect back to products page after 2 seconds
        setTimeout(() => {
          window.location.href = 'products.html';
        }, 2000);
        
      } catch (error) {
        console.error('Error updating product:', error);
        showMessage(`Error updating product: ${error.message}`, 'error');
      }
    });

    // Show delete modal
    function showDeleteModal() {
      const productName = document.getElementById('productName').value || 'this product';
      deleteMessage.textContent = `Are you sure you want to delete "${productName}"? This action cannot be undone. All associated images will also be deleted.`;
      openModal('deleteModal');
    }

    // Delete product
    async function deleteProduct() {
      try {
        // Delete product images from storage first
        if (existingImages.length > 0) {
          const filePaths = existingImages.map(url => {
            const urlParts = url.split('/');
            const filename = urlParts[urlParts.length - 1];
            return `product-images/${currentProductId}/${filename}`;
          });
          
          await sb.storage
            .from('product-images')
            .remove(filePaths);
        }
        
        // Delete the product record - FIXED: Delete from products_new
        const { error } = await sb
          .from('products_new')
          .delete()
          .eq('id', currentProductId);
        
        if (error) throw error;
        
        showMessage('Product deleted successfully!', 'success');
        
        // Redirect to products page after 1 second
        setTimeout(() => {
          window.location.href = 'products.html';
        }, 1000);
        
      } catch (error) {
        console.error('Error deleting product:', error);
        showMessage(`Error deleting product: ${error.message}`, 'error');
        closeModal('deleteModal');
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      document.body.style.overflow = '';
    }

    // Show toast message
    function showMessage(text, type) {
      // Remove existing messages
      const existingMessages = document.querySelectorAll('.status-message');
      existingMessages.forEach(msg => msg.remove());
      
      // Create toast message
      const toast = document.createElement('div');
      toast.className = `status-message ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
        <span>${text}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Toggle mobile sidebar
    window.toggleSidebar = function() {
      const mobileSidebar = document.getElementById('mobileSidebar');
      const overlay = document.getElementById('overlay');
      mobileSidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      document.body.style.overflow = mobileSidebar.classList.contains('active') ? 'hidden' : '';
    };

    // Logout function
    window.logout = async function() {
      if (confirm('Are you sure you want to logout?')) {
        await sb.auth.signOut();
        window.location.href = 'login.html';
      }
    };

    // Close sidebar when clicking outside
    document.addEventListener('click', function(event) {
      const mobileSidebar = document.getElementById('mobileSidebar');
      const menuToggle = document.querySelector('.mobile-menu-toggle');
      
      if (window.innerWidth <= 768 && 
          mobileSidebar && menuToggle &&
          !mobileSidebar.contains(event.target) && 
          !menuToggle.contains(event.target) &&
          mobileSidebar.classList.contains('active')) {
        toggleSidebar();
      }
    });

    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileSidebar = document.getElementById('mobileSidebar');
        if (mobileSidebar && mobileSidebar.classList.contains('active')) {
          toggleSidebar();
        }
      }
    });
  </script>
</body>
</html>