<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sales Reports | iBlue Commerce</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ===== MOBILE-FIRST RESET & BASE STYLES ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --primary: #003cff;
      --primary-dark: #0028cc;
      --secondary: #6c757d;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --sidebar-width: 250px;
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
    }

    html {
      font-size: 14px;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      overflow-x: hidden;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* ===== TOUCH-FRIENDLY BUTTONS & INPUTS ===== */
    button,
    select,
    input,
    .btn,
    .btn-icon,
    .nav-item a {
      min-height: 44px;
      min-width: 44px;
      touch-action: manipulation;
    }

    select,
    input,
    textarea {
      font-size: 16px !important;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    /* ===== SIDEBAR - MOBILE OVERLAY ===== */
    .sidebar {
      width: 100%;
      max-width: 280px;
      background: white;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      position: fixed;
      height: 100vh;
      height: -webkit-fill-available;
      overflow-y: auto;
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      left: 0;
      top: 0;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }

    .sidebar.active {
      transform: translateX(0);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      backdrop-filter: blur(2px);
    }

    .sidebar-overlay.active {
      display: block;
    }

    .sidebar-header {
      padding: 25px 20px;
      border-bottom: 1px solid #eaeaea;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 5px;
    }

    .logo i {
      font-size: 1.8rem;
    }

    .logo span {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .admin-role {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-left: 42px;
    }

    .user-info {
      padding: 20px;
      border-bottom: 1px solid #eaeaea;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .user-details h4 {
      margin-bottom: 5px;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-details p {
      color: var(--secondary);
      font-size: 0.85rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-menu {
      list-style: none;
      padding: 20px 0;
    }

    .nav-item {
      margin-bottom: 5px;
    }

    .nav-item a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: #555;
      text-decoration: none;
      transition: all 0.3s;
      border-left: 3px solid transparent;
      white-space: nowrap;
    }

    .nav-item a:hover, .nav-item a.active {
      background: rgba(0, 60, 255, 0.05);
      color: var(--primary);
      border-left-color: var(--primary);
    }

    .nav-item i {
      width: 24px;
      margin-right: 12px;
      font-size: 1.1rem;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-divider {
      padding: 15px 20px;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--secondary);
      font-weight: 600;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid #eaeaea;
      margin-top: auto;
      position: sticky;
      bottom: 0;
      background: white;
    }

    /* ===== MOBILE MENU TOGGLE ===== */
    .mobile-menu-toggle {
      display: flex;
      position: fixed;
      top: 20px;
      left: 15px;
      z-index: 1001;
      background: var(--primary);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 10px;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 12px rgba(0, 60, 255, 0.3);
    }

    /* ===== MAIN CONTENT - MOBILE OPTIMIZED ===== */
    .main-content {
      flex: 1;
      padding: 20px 15px 30px;
      min-height: 100vh;
      width: 100%;
      padding-top: 70px;
    }

    .top-bar {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 25px;
      padding: 20px 15px;
      border-bottom: 1px solid #eaeaea;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      position: relative;
      margin-top: 10px;
    }

    .page-title h1 {
      font-size: 1.5rem;
      color: var(--dark);
      margin-bottom: 5px;
      line-height: 1.2;
    }

    .page-title p {
      color: var(--secondary);
      font-size: 0.9rem;
      line-height: 1.3;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: flex-start;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      font-size: 0.9rem;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover, .btn-primary:active {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 60, 255, 0.2);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-light {
      background: var(--light);
      color: var(--dark);
      border: 1px solid #ddd;
    }

    .notification-badge {
      position: relative;
    }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* ===== SALES STATS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.3s;
      min-height: 120px;
    }

    .stat-card:active {
      transform: scale(0.98);
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: white;
      flex-shrink: 0;
    }

    .stat-icon.revenue { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); }
    .stat-icon.orders { background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%); }
    .stat-icon.customers { background: linear-gradient(135deg, var(--info) 0%, #138496 100%); }
    .stat-icon.average { background: linear-gradient(135deg, var(--warning) 0%, #e0a800 100%); }
    .stat-icon.refunds { background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%); }

    .stat-content h3 {
      font-size: 1.5rem;
      margin-bottom: 5px;
      color: var(--dark);
      line-height: 1;
    }

    .stat-content p {
      color: var(--secondary);
      font-size: 0.85rem;
      margin-bottom: 3px;
    }

    .stat-change {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      margin-top: 3px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    /* ===== FILTER SECTION ===== */
    .filter-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-row {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 15px;
    }

    @media (min-width: 768px) {
      .filter-row {
        flex-direction: row;
        align-items: center;
      }
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    @media (min-width: 576px) {
      .filter-group {
        flex-direction: row;
        align-items: center;
      }
    }

    .filter-input {
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 0.95rem;
      background: white;
      width: 100%;
    }

    .filter-select {
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: white;
      font-size: 0.95rem;
      width: 100%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 40px;
    }

    @media (min-width: 768px) {
      .filter-select {
        width: auto;
        min-width: 150px;
      }
    }

    /* ===== CHARTS SECTION ===== */
    .charts-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (min-width: 992px) {
      .charts-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
    }

    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      min-height: 300px;
    }

    .chart-header {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    @media (min-width: 480px) {
      .chart-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .chart-header h3 {
      font-size: 1.1rem;
      color: var(--dark);
    }

    .chart-container {
      position: relative;
      height: 250px;
      width: 100%;
    }

    @media (min-width: 1200px) {
      .chart-container {
        height: 300px;
      }
    }

    /* ===== REPORTS TABLE ===== */
    .reports-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    @media (min-width: 576px) {
      .section-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
    }

    .section-header h3 {
      font-size: 1.2rem;
      color: var(--dark);
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
    }

    th {
      background: rgba(0, 60, 255, 0.05);
      color: var(--dark);
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    tr:hover {
      background: rgba(0, 60, 255, 0.02);
    }

    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .status-pending { background: rgba(255, 193, 7, 0.1); color: #b38b00; }
    .status-paid { background: rgba(40, 167, 69, 0.1); color: var(--success); }
    .status-shipped { background: rgba(23, 162, 184, 0.1); color: var(--info); }
    .status-completed { background: rgba(40, 167, 69, 0.1); color: var(--success); }
    .status-cancelled { background: rgba(220, 53, 69, 0.1); color: var(--danger); }
    .status-refunded { background: rgba(108, 117, 125, 0.1); color: var(--secondary); }

    /* ===== SUMMARY SECTION ===== */
    .summary-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .summary-item {
      background: var(--light);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .summary-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .summary-label {
      color: var(--secondary);
      font-size: 0.9rem;
    }

    /* ===== BOTTOM NAVIGATION FOR MOBILE ===== */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #eaeaea;
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 767px) {
      .bottom-nav {
        display: flex;
        justify-content: space-around;
        padding-bottom: max(10px, var(--safe-area-bottom));
      }
      
      .bottom-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        text-decoration: none;
        color: var(--secondary);
        font-size: 0.75rem;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s;
      }
      
      .bottom-nav-item.active {
        color: var(--primary);
        background: rgba(0, 60, 255, 0.05);
      }
      
      .bottom-nav-item i {
        font-size: 1.2rem;
      }
    }

    /* ===== LOADING SPINNER ===== */
    .loading-spinner {
      display: none;
      justify-content: center;
      align-items: center;
      padding: 40px;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 60, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== RESPONSIVE BREAKPOINTS ===== */
    @media (min-width: 480px) {
      html {
        font-size: 15px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
      
      .main-content {
        padding: 20px 20px 30px;
      }
    }

    @media (min-width: 576px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .top-bar {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
      }
      
      .top-actions {
        width: auto;
        justify-content: flex-end;
      }
      
      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 768px) {
      html {
        font-size: 16px;
      }
      
      .sidebar {
        transform: translateX(0);
        position: sticky;
        top: 0;
        max-width: var(--sidebar-width);
      }
      
      .sidebar-overlay {
        display: none !important;
      }
      
      .mobile-menu-toggle {
        display: none;
      }
      
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 30px;
        padding-top: 30px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .summary-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (min-width: 992px) {
      .stats-grid {
        grid-template-columns: repeat(5, 1fr);
      }
      
      .charts-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* ===== TOAST MESSAGES ===== */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      left: 20px;
      z-index: 4000;
      padding: 14px;
      border-radius: 10px;
      font-size: 0.9rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideDown 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.success {
      background: rgba(40, 167, 69, 0.9);
      color: white;
      border-left: 4px solid #218838;
    }

    .toast.error {
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border-left: 4px solid #c82333;
    }

    .toast.warning {
      background: rgba(255, 193, 7, 0.9);
      color: #212529;
      border-left: 4px solid #e0a800;
    }

    .toast.info {
      background: rgba(23, 162, 184, 0.9);
      color: white;
      border-left: 4px solid #138496;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--secondary);
    }

    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #ddd;
    }

    .empty-state h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: var(--dark);
    }

    .empty-state p {
      font-size: 1rem;
      max-width: 400px;
      margin: 0 auto 20px;
    }

    /* ===== Search box ===== */
    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
    }

    .search-box input {
      padding-left: 45px;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
    <i class="fas fa-bars"></i>
  </button>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <i class="fas fa-shopping-bag" aria-hidden="true"></i>
        <span>iBlue</span>
      </div>
      <div class="admin-role">Sales Reports</div>
    </div>

    <div class="user-info">
      <div class="user-avatar" id="userAvatar" aria-label="User avatar">A</div>
      <div class="user-details">
        <h4 id="userName">User</h4>
        <p id="userEmail">user@example.com</p>
      </div>
    </div>

    <ul class="nav-menu">
      <li class="nav-item"><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
      <li class="nav-item"><a href="products.html"><i class="fas fa-box"></i> Products</a></li>
      <li class="nav-item"><a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a></li>
      <li class="nav-item"><a href="customers.html"><i class="fas fa-users"></i> Customers</a></li>
      <li class="nav-item"><a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
      
      <li class="nav-divider">Management</li>
      
      <li class="nav-item"><a href="admin-add-product.html"><i class="fas fa-plus-circle"></i> Add Product</a></li>
      <li class="nav-item"><a href="categories.html"><i class="fas fa-tags"></i> Categories</a></li>
      <li class="nav-item"><a href="inventory.html"><i class="fas fa-warehouse"></i> Inventory</a></li>
      <li class="nav-item"><a href="#" class="active"><i class="fas fa-file-invoice-dollar"></i> Sales Reports</a></li>
      
      <li class="nav-divider">Settings</li>
      
      <li class="nav-item"><a href="System-settings.html"><i class="fas fa-cog"></i> System Settings</a></li>
      <li class="nav-item"><a href="admin-users.html"><i class="fas fa-user-cog"></i> Admin Users</a></li>
      <li class="nav-item"><a href="roles-permissions.html"><i class="fas fa-user-shield"></i> Roles & Permissions</a></li>
      <li class="nav-item"><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>

    <div class="sidebar-footer">
      <div style="font-size: 0.8rem; color: var(--secondary); text-align: center;">
        <p><i class="fas fa-shield-alt"></i> Secure Admin Portal</p>
        <p>v2.1.4 â€¢ Last login: <span id="lastLoginTime">Today</span></p>
      </div>
    </div>
  </nav>

  <!-- Bottom Navigation for Mobile -->
  <div class="bottom-nav">
    <a href="dashboard.html" class="bottom-nav-item">
      <i class="fas fa-tachometer-alt"></i>
      <span>Dashboard</span>
    </a>
    <a href="products.html" class="bottom-nav-item">
      <i class="fas fa-box"></i>
      <span>Products</span>
    </a>
    <a href="orders.html" class="bottom-nav-item">
      <i class="fas fa-shopping-cart"></i>
      <span>Orders</span>
    </a>
    <a href="customers.html" class="bottom-nav-item">
      <i class="fas fa-users"></i>
      <span>Customers</span>
    </a>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="page-title">
        <h1 id="pageTitle">Sales Reports</h1>
        <p id="pageSubtitle">Generate and analyze detailed sales reports</p>
      </div>
      
      <div class="top-actions">
        <button class="btn btn-light notification-badge" aria-label="Notifications">
          <i class="fas fa-bell"></i>
          <span class="badge" id="notificationCount">0</span>
        </button>
        <button class="btn btn-primary" onclick="generateReport()">
          <i class="fas fa-chart-line"></i> Generate Report
        </button>
        <button class="btn btn-light" onclick="refreshData()">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Sales Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon revenue" aria-hidden="true">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalRevenue">UGX 0</h3>
          <p>Total Revenue</p>
          <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="revenueChange">0%</span> from last period
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon orders" aria-hidden="true">
          <i class="fas fa-shopping-cart"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalOrders">0</h3>
          <p>Total Orders</p>
          <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="ordersChange">0%</span> from last period
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon customers" aria-hidden="true">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="totalCustomers">0</h3>
          <p>Customers</p>
          <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="customersChange">0%</span> from last period
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon average" aria-hidden="true">
          <i class="fas fa-calculator"></i>
        </div>
        <div class="stat-content">
          <h3 id="averageOrder">UGX 0</h3>
          <p>Avg Order Value</p>
          <div class="stat-change positive">
            <i class="fas fa-arrow-up"></i>
            <span id="averageOrderChange">0%</span> from last period
          </div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon refunds" aria-hidden="true">
          <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="refundRate">0%</h3>
          <p>Refund Rate</p>
          <div class="stat-change negative">
            <i class="fas fa-arrow-down"></i>
            <span id="refundRateChange">0%</span> from last period
          </div>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <input type="date" id="fromDate" class="filter-input" value="">
          <span style="padding: 0 10px; color: var(--secondary); align-self: center;">to</span>
          <input type="date" id="toDate" class="filter-input" value="">
        </div>
        
        <div class="filter-group">
          <select class="filter-select" id="reportType">
            <option value="detailed">Detailed Report</option>
            <option value="summary">Summary Report</option>
            <option value="daily">Daily Sales</option>
            <option value="monthly">Monthly Sales</option>
            <option value="yearly">Yearly Sales</option>
          </select>
          
          <select class="filter-select" id="statusFilter">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="shipped">Shipped</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
            <option value="refunded">Refunded</option>
          </select>
          
          <select class="filter-select" id="customerFilter">
            <option value="">All Customers</option>
            <option value="new">New Customers</option>
            <option value="returning">Returning Customers</option>
          </select>
        </div>
      </div>
      
      <div class="filter-row">
        <button class="btn btn-primary" onclick="generateReport()">
          <i class="fas fa-filter"></i> Generate Report
        </button>
        <button class="btn btn-success" onclick="exportReport('csv')">
          <i class="fas fa-file-csv"></i> Export CSV
        </button>
        <button class="btn btn-warning" onclick="exportReport('excel')">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn btn-danger" onclick="exportReport('pdf')">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="btn btn-light" onclick="clearFilters()">
          <i class="fas fa-times"></i> Clear Filters
        </button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="reportLoading">
      <div class="spinner"></div>
      <span>Generating sales report...</span>
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState">
      <i class="fas fa-chart-line"></i>
      <h3>No Sales Data Yet</h3>
      <p>Generate a sales report by selecting a date range and clicking "Generate Report"</p>
      <button class="btn btn-primary" onclick="generateReport()">
        <i class="fas fa-chart-line"></i> Generate Your First Report
      </button>
    </div>

    <!-- Charts Section -->
    <div class="charts-section" id="chartsSection" style="display: none;">
      <!-- Sales Trend Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Sales Trend</h3>
          <select class="filter-select" id="trendChartType" onchange="updateTrendChart()" style="min-width: 120px;">
            <option value="line">Line Chart</option>
            <option value="bar">Bar Chart</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="salesTrendChart"></canvas>
        </div>
      </div>

      <!-- Sales by Status Chart -->
      <div class="chart-card">
        <div class="chart-header">
          <h3>Sales by Status</h3>
          <select class="filter-select" id="statusChartType" onchange="updateStatusChart()" style="min-width: 120px;">
            <option value="doughnut">Doughnut</option>
            <option value="pie">Pie Chart</option>
            <option value="bar">Bar Chart</option>
          </select>
        </div>
        <div class="chart-container">
          <canvas id="salesStatusChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-section" id="summarySection" style="display: none;">
      <h3>Report Summary</h3>
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value" id="summaryRevenue">UGX 0</div>
          <div class="summary-label">Total Revenue</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryOrders">0</div>
          <div class="summary-label">Total Orders</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryCustomers">0</div>
          <div class="summary-label">Customers</div>
        </div>
        <div class="summary-item">
          <div class="summary-value" id="summaryAverage">UGX 0</div>
          <div class="summary-label">Avg Order Value</div>
        </div>
      </div>
    </div>

    <!-- Reports Table -->
    <div class="reports-section" id="reportsSection" style="display: none;">
      <div class="section-header">
        <h3>Sales Report Details</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-light" onclick="printReport()">
            <i class="fas fa-print"></i> Print
          </button>
          <button class="btn btn-light" onclick="emailReport()">
            <i class="fas fa-envelope"></i> Email
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <table id="reportTable">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Email</th>
              <th>Status</th>
              <th>Items</th>
              <th>Subtotal</th>
              <th>Tax</th>
              <th>Shipping</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="reportTableBody">
            <!-- Report data will be loaded here -->
          </tbody>
          <tfoot>
            <tr>
              <td colspan="5" style="text-align: right; font-weight: 600;">Totals:</td>
              <td id="totalItems">0</td>
              <td id="totalSubtotal">UGX 0</td>
              <td id="totalTax">UGX 0</td>
              <td id="totalShipping">UGX 0</td>
              <td id="totalAmount" style="font-weight: 700; color: var(--primary);">UGX 0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </main>

  <script>
    // Initialize Supabase client
    const supabaseUrl = "https://amxhpxqakqrjjihwkzcq.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFteGhweHFha3FyamppaHdremNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5Nzc2NjUsImV4cCI6MjA4MzU1MzY2NX0.yIAZtz3bUc_ZxF8-f4cqW1fKJgFiRsiJdj4qgCDmM0g";
    
    const sb = supabase.createClient(supabaseUrl, supabaseKey);
    
    // Chart instances
    let salesTrendChart = null;
    let salesStatusChart = null;
    
    // Global variables
    let currentReportData = [];
    let reportSummary = {};
    let currentUser = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      await checkAdminAuth();
      setupEventListeners();
      setDefaultDates();
      loadInitialStats();
    });

    // Check admin authentication
    async function checkAdminAuth() {
      const { data: { session } } = await sb.auth.getSession();
      
      if (!session) {
        window.location.href = 'admin-login.html?redirect=unauthorized';
        return;
      }
      
      // Check if user is admin/seller
      const { data: profile, error } = await sb
        .from('user_profiles')
        .select('*')
        .eq('id', session.user.id)
        .single();
      
      if (error || (!profile || (profile.account_type !== 'admin' && profile.account_type !== 'seller'))) {
        window.location.href = 'admin-login.html?redirect=unauthorized';
        return;
      }
      
      currentUser = session.user;
      
      // Update UI with user info
      document.getElementById('userName').textContent = profile.first_name || profile.username || 'User';
      document.getElementById('userEmail').textContent = session.user.email;
      document.getElementById('userAvatar').textContent = (profile.first_name?.[0] || profile.username?.[0] || 'U').toUpperCase();
      
      // Set last login time
      const lastLogin = localStorage.getItem('lastAdminLogin');
      if (lastLogin) {
        document.getElementById('lastLoginTime').textContent = new Date(lastLogin).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }

    // Currency formatter for Uganda
    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-UG', {
        style: 'currency',
        currency: 'UGX',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Set default dates to last 30 days
      setDefaultDates();
      
      // Check for inactivity
      let inactivityTimer;
      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
          window.location.href = 'admin-login.html?redirect=timeout';
        }, 30 * 60 * 1000); // 30 minutes
      }
      
      document.addEventListener('touchstart', resetInactivityTimer);
      document.addEventListener('mousemove', resetInactivityTimer);
      document.addEventListener('keypress', resetInactivityTimer);
      resetInactivityTimer();
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mobileToggle = document.querySelector('.mobile-menu-toggle');
        
        if (window.innerWidth <= 768 && 
            !sidebar.contains(event.target) && 
            !mobileToggle.contains(event.target) &&
            sidebar.classList.contains('active')) {
          toggleSidebar();
        }
      });
      
      // Handle keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + G to generate report
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
          e.preventDefault();
          generateReport();
        }
        
        // Ctrl/Cmd + E to export CSV
        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
          e.preventDefault();
          exportReport('csv');
        }
        
        // Escape to close sidebar on mobile
        if (e.key === 'Escape' && window.innerWidth <= 768) {
          document.getElementById('sidebar').classList.remove('active');
          document.getElementById('sidebarOverlay').classList.remove('active');
        }
      });
    }

    // Toggle sidebar on mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Set default dates (last 30 days)
    function setDefaultDates() {
      const today = new Date();
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(today.getDate() - 30);
      
      document.getElementById('fromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('toDate').value = today.toISOString().split('T')[0];
    }

    // Load initial stats for the dashboard cards
    async function loadInitialStats() {
      try {
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);
        const sixtyDaysAgo = new Date();
        sixtyDaysAgo.setDate(today.getDate() - 60);
        
        // Get current period stats (last 30 days)
        const { data: currentOrders, error: currentError } = await sb
          .from('orders')
          .select('*')
          .gte('created_at', thirtyDaysAgo.toISOString())
          .lte('created_at', today.toISOString());
        
        if (currentError) throw currentError;
        
        // Get previous period stats (30-60 days ago)
        const { data: previousOrders, error: previousError } = await sb
          .from('orders')
          .select('*')
          .gte('created_at', sixtyDaysAgo.toISOString())
          .lt('created_at', thirtyDaysAgo.toISOString());
        
        if (previousError) throw previousError;
        
        // Calculate current period totals
        const currentRevenue = currentOrders?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;
        const currentOrderCount = currentOrders?.length || 0;
        const currentCustomerCount = new Set(currentOrders?.map(o => o.customer_email)).size || 0;
        const currentAvgOrder = currentOrderCount > 0 ? currentRevenue / currentOrderCount : 0;
        
        // Calculate previous period totals
        const previousRevenue = previousOrders?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;
        const previousOrderCount = previousOrders?.length || 0;
        const previousCustomerCount = new Set(previousOrders?.map(o => o.customer_email)).size || 0;
        const previousAvgOrder = previousOrderCount > 0 ? previousRevenue / previousOrderCount : 0;
        
        // Calculate percentage changes
        const revenueChange = previousRevenue > 0 ? ((currentRevenue - previousRevenue) / previousRevenue * 100).toFixed(1) : 0;
        const ordersChange = previousOrderCount > 0 ? ((currentOrderCount - previousOrderCount) / previousOrderCount * 100).toFixed(1) : 0;
        const customersChange = previousCustomerCount > 0 ? ((currentCustomerCount - previousCustomerCount) / previousCustomerCount * 100).toFixed(1) : 0;
        const avgOrderChange = previousAvgOrder > 0 ? ((currentAvgOrder - previousAvgOrder) / previousAvgOrder * 100).toFixed(1) : 0;
        
        // Update UI
        document.getElementById('totalRevenue').textContent = formatCurrency(currentRevenue);
        document.getElementById('totalOrders').textContent = currentOrderCount.toLocaleString();
        document.getElementById('totalCustomers').textContent = currentCustomerCount.toLocaleString();
        document.getElementById('averageOrder').textContent = formatCurrency(currentAvgOrder);
        
        // Update percentage changes
        document.getElementById('revenueChange').textContent = `${revenueChange}%`;
        document.getElementById('ordersChange').textContent = `${ordersChange}%`;
        document.getElementById('customersChange').textContent = `${customersChange}%`;
        document.getElementById('averageOrderChange').textContent = `${avgOrderChange}%`;
        
        // Calculate refund rate (from refunds table)
        const { data: refunds, error: refundsError } = await sb
          .from('refunds')
          .select('amount, order_id')
          .gte('created_at', thirtyDaysAgo.toISOString())
          .lte('created_at', today.toISOString());
        
        if (!refundsError && refunds) {
          const totalRefunds = refunds.reduce((sum, refund) => sum + (refund.amount || 0), 0);
          const refundRate = currentRevenue > 0 ? (totalRefunds / currentRevenue * 100).toFixed(1) : 0;
          document.getElementById('refundRate').textContent = `${refundRate}%`;
          
          // Get previous period refunds for comparison
          const { data: prevRefunds } = await sb
            .from('refunds')
            .select('amount')
            .gte('created_at', sixtyDaysAgo.toISOString())
            .lt('created_at', thirtyDaysAgo.toISOString());
          
          const prevTotalRefunds = prevRefunds?.reduce((sum, refund) => sum + (refund.amount || 0), 0) || 0;
          const prevRefundRate = previousRevenue > 0 ? (prevTotalRefunds / previousRevenue * 100).toFixed(1) : 0;
          const refundRateChange = prevRefundRate > 0 ? (refundRate - prevRefundRate).toFixed(1) : 0;
          
          document.getElementById('refundRateChange').textContent = `${refundRateChange}%`;
          if (refundRateChange < 0) {
            document.querySelector('#refundRateChange').closest('.stat-change').classList.remove('negative');
            document.querySelector('#refundRateChange').closest('.stat-change').classList.add('positive');
          }
        }
        
      } catch (error) {
        console.error('Error loading initial stats:', error);
        // Don't show error toast for initial load
      }
    }

    // Initialize charts
    function initializeCharts() {
      // Sales Trend Chart
      const trendCtx = document.getElementById('salesTrendChart').getContext('2d');
      salesTrendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Sales (UGX)',
            data: [],
            borderColor: '#003cff',
            backgroundColor: 'rgba(0, 60, 255, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCurrency(context.raw);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      // Sales by Status Chart
      const statusCtx = document.getElementById('salesStatusChart').getContext('2d');
      salesStatusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [
              '#28a745',
              '#ffc107',
              '#17a2b8',
              '#dc3545',
              '#6c757d'
            ],
            borderWidth: 0,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} orders (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    // Generate sales report
    async function generateReport() {
      const loading = document.getElementById('reportLoading');
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const reportType = document.getElementById('reportType').value;
      const customerFilter = document.getElementById('customerFilter').value;
      
      // Validate dates
      if (!fromDate || !toDate) {
        showToast('Please select both start and end dates', 'warning');
        return;
      }
      
      if (new Date(fromDate) > new Date(toDate)) {
        showToast('Start date cannot be after end date', 'warning');
        return;
      }
      
      loading.style.display = 'flex';
      document.getElementById('emptyState').style.display = 'none';
      
      try {
        // Build query for orders
        let query = sb
          .from('orders')
          .select(`
            *,
            order_items (*)
          `)
          .gte('created_at', fromDate + 'T00:00:00')
          .lte('created_at', toDate + 'T23:59:59')
          .order('created_at', { ascending: false });
        
        if (statusFilter) {
          query = query.eq('status', statusFilter);
        }
        
        const { data: orders, error } = await query;
        
        if (error) throw error;
        
        currentReportData = orders || [];
        
        if (currentReportData.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
          document.getElementById('emptyState').innerHTML = `
            <i class="fas fa-chart-line"></i>
            <h3>No Sales Data Found</h3>
            <p>No orders found for the selected date range. Try adjusting your filters.</p>
            <button class="btn btn-primary" onclick="clearFilters()">
              <i class="fas fa-filter"></i> Clear Filters
            </button>
          `;
          hideReportSections();
          showToast('No sales data found for the selected period', 'info');
          return;
        }
        
        // Process data based on report type
        if (reportType === 'summary') {
          await generateSummaryReport(orders);
        } else if (reportType === 'daily') {
          await generateDailyReport(orders);
        } else if (reportType === 'monthly') {
          await generateMonthlyReport(orders);
        } else if (reportType === 'yearly') {
          await generateYearlyReport(orders);
        } else {
          await generateDetailedReport(orders);
        }
        
        // Initialize charts if not already done
        if (!salesTrendChart) {
          initializeCharts();
        }
        
        // Update UI
        updateReportUI();
        
        showToast('Report generated successfully', 'success');
        
      } catch (error) {
        console.error('Error generating report:', error);
        showToast('Error generating report: ' + error.message, 'error');
      } finally {
        loading.style.display = 'none';
      }
    }

    // Hide report sections
    function hideReportSections() {
      document.getElementById('chartsSection').style.display = 'none';
      document.getElementById('summarySection').style.display = 'none';
      document.getElementById('reportsSection').style.display = 'none';
    }

    // Generate detailed report
    async function generateDetailedReport(orders) {
      const tableBody = document.getElementById('reportTableBody');
      tableBody.innerHTML = '';
      
      let totalItems = 0;
      let totalSubtotal = 0;
      let totalTax = 0;
      let totalShipping = 0;
      let totalAmount = 0;
      
      // Process each order
      for (const order of orders) {
        // Calculate order details from order_items or use estimates
        const orderItems = order.order_items || [];
        const itemsCount = orderItems.length;
        const itemsTotal = orderItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
        
        // Use actual data if available, otherwise estimate
        const subtotal = order.subtotal || itemsTotal || order.total * 0.85;
        const tax = order.tax || order.total * 0.10;
        const shipping = order.shipping_cost || order.total * 0.05;
        const total = order.total || subtotal + tax + shipping;
        
        totalItems += itemsCount;
        totalSubtotal += subtotal;
        totalTax += tax;
        totalShipping += shipping;
        totalAmount += total;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>#${order.id}</strong></td>
          <td>${new Date(order.created_at).toLocaleDateString()}</td>
          <td>${order.customer_name || 'Customer'}</td>
          <td>${order.customer_email || 'N/A'}</td>
          <td><span class="status-badge status-${order.status || 'pending'}">${(order.status || 'pending').charAt(0).toUpperCase() + (order.status || 'pending').slice(1)}</span></td>
          <td>${itemsCount}</td>
          <td>${formatCurrency(subtotal)}</td>
          <td>${formatCurrency(tax)}</td>
          <td>${formatCurrency(shipping)}</td>
          <td><strong>${formatCurrency(total)}</strong></td>
        `;
        tableBody.appendChild(row);
      }
      
      // Update totals
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalSubtotal').textContent = formatCurrency(totalSubtotal);
      document.getElementById('totalTax').textContent = formatCurrency(totalTax);
      document.getElementById('totalShipping').textContent = formatCurrency(totalShipping);
      document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
      
      // Store summary data
      reportSummary = {
        totalRevenue: totalAmount,
        totalOrders: orders.length,
        totalCustomers: new Set(orders.map(o => o.customer_email)).size,
        averageOrderValue: orders.length > 0 ? totalAmount / orders.length : 0,
        totalItems,
        totalSubtotal,
        totalTax,
        totalShipping
      };
      
      // Update charts
      updateChartsWithData(orders);
    }

    // Generate summary report
    async function generateSummaryReport(orders) {
      // Similar to detailed but with aggregated data
      await generateDetailedReport(orders);
    }

    // Generate daily report
    async function generateDailyReport(orders) {
      // Group orders by day
      const dailyData = {};
      orders.forEach(order => {
        const date = new Date(order.created_at).toLocaleDateString();
        const orderItems = order.order_items || [];
        const itemsCount = orderItems.length;
        
        if (!dailyData[date]) {
          dailyData[date] = {
            orders: 0,
            revenue: 0,
            items: 0,
            customers: new Set()
          };
        }
        dailyData[date].orders++;
        dailyData[date].revenue += order.total || 0;
        dailyData[date].items += itemsCount;
        if (order.customer_email) {
          dailyData[date].customers.add(order.customer_email);
        }
      });
      
      // Display daily summary
      const tableBody = document.getElementById('reportTableBody');
      tableBody.innerHTML = '';
      
      let totalRevenue = 0;
      let totalOrders = 0;
      let totalCustomers = 0;
      let totalItems = 0;
      
      Object.entries(dailyData).forEach(([date, data]) => {
        totalRevenue += data.revenue;
        totalOrders += data.orders;
        totalCustomers += data.customers.size;
        totalItems += data.items;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="2"><strong>${date}</strong></td>
          <td>${data.customers.size}</td>
          <td>${data.orders}</td>
          <td>${data.items}</td>
          <td colspan="4"></td>
          <td><strong>${formatCurrency(data.revenue)}</strong></td>
        `;
        tableBody.appendChild(row);
      });
      
      // Update totals
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalSubtotal').textContent = '-';
      document.getElementById('totalTax').textContent = '-';
      document.getElementById('totalShipping').textContent = '-';
      document.getElementById('totalAmount').textContent = formatCurrency(totalRevenue);
      
      // Store summary data
      reportSummary = {
        totalRevenue,
        totalOrders,
        totalCustomers,
        averageOrderValue: totalOrders > 0 ? totalRevenue / totalOrders : 0,
        totalItems
      };
      
      // Update charts
      updateChartsWithData(orders);
    }

    // Generate monthly report
    async function generateMonthlyReport(orders) {
      // Group orders by month
      const monthlyData = {};
      orders.forEach(order => {
        const date = new Date(order.created_at);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const orderItems = order.order_items || [];
        const itemsCount = orderItems.length;
        
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = {
            month: monthName,
            orders: 0,
            revenue: 0,
            items: 0,
            customers: new Set()
          };
        }
        monthlyData[monthKey].orders++;
        monthlyData[monthKey].revenue += order.total || 0;
        monthlyData[monthKey].items += itemsCount;
        if (order.customer_email) {
          monthlyData[monthKey].customers.add(order.customer_email);
        }
      });
      
      // Display monthly summary
      const tableBody = document.getElementById('reportTableBody');
      tableBody.innerHTML = '';
      
      let totalRevenue = 0;
      let totalOrders = 0;
      let totalCustomers = 0;
      let totalItems = 0;
      
      Object.values(monthlyData).sort((a, b) => a.month.localeCompare(b.month)).forEach(data => {
        totalRevenue += data.revenue;
        totalOrders += data.orders;
        totalCustomers += data.customers.size;
        totalItems += data.items;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="2"><strong>${data.month}</strong></td>
          <td>${data.customers.size}</td>
          <td>${data.orders}</td>
          <td>${data.items}</td>
          <td colspan="4"></td>
          <td><strong>${formatCurrency(data.revenue)}</strong></td>
        `;
        tableBody.appendChild(row);
      });
      
      // Update totals
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalSubtotal').textContent = '-';
      document.getElementById('totalTax').textContent = '-';
      document.getElementById('totalShipping').textContent = '-';
      document.getElementById('totalAmount').textContent = formatCurrency(totalRevenue);
      
      // Store summary data
      reportSummary = {
        totalRevenue,
        totalOrders,
        totalCustomers,
        averageOrderValue: totalOrders > 0 ? totalRevenue / totalOrders : 0,
        totalItems
      };
      
      // Update charts
      updateChartsWithData(orders);
    }

    // Generate yearly report
    async function generateYearlyReport(orders) {
      // Similar to monthly but grouped by year
      await generateMonthlyReport(orders);
    }

    // Update charts with data
    function updateChartsWithData(orders) {
      // Update trend chart based on date range
      const fromDate = new Date(document.getElementById('fromDate').value);
      const toDate = new Date(document.getElementById('toDate').value);
      const daysDiff = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24));
      
      let labels = [];
      let data = [];
      
      if (daysDiff <= 7) {
        // Daily data for 7 days
        for (let i = 0; i <= daysDiff; i++) {
          const date = new Date(fromDate);
          date.setDate(date.getDate() + i);
          labels.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
          
          const dateStr = date.toISOString().split('T')[0];
          const dailyRevenue = orders
            .filter(o => o.created_at.startsWith(dateStr))
            .reduce((sum, o) => sum + (o.total || 0), 0);
          
          data.push(dailyRevenue);
        }
      } else if (daysDiff <= 31) {
        // Weekly data
        const weeks = Math.ceil(daysDiff / 7);
        for (let i = 0; i < weeks; i++) {
          const weekStart = new Date(fromDate);
          weekStart.setDate(weekStart.getDate() + (i * 7));
          const weekEnd = new Date(weekStart);
          weekEnd.setDate(weekEnd.getDate() + 6);
          
          labels.push(`Week ${i + 1} (${weekStart.getDate()}/${weekStart.getMonth()+1})`);
          
          const weekRevenue = orders
            .filter(o => {
              const orderDate = new Date(o.created_at);
              return orderDate >= weekStart && orderDate <= weekEnd;
            })
            .reduce((sum, o) => sum + (o.total || 0), 0);
          
          data.push(weekRevenue);
        }
      } else {
        // Monthly data
        const months = [];
        let currentMonth = new Date(fromDate);
        
        while (currentMonth <= toDate) {
          const monthStr = currentMonth.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
          labels.push(monthStr);
          
          const monthStart = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
          const monthEnd = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
          
          const monthRevenue = orders
            .filter(o => {
              const orderDate = new Date(o.created_at);
              return orderDate >= monthStart && orderDate <= monthEnd;
            })
            .reduce((sum, o) => sum + (o.total || 0), 0);
          
          data.push(monthRevenue);
          
          currentMonth.setMonth(currentMonth.getMonth() + 1);
        }
      }
      
      salesTrendChart.data.labels = labels;
      salesTrendChart.data.datasets[0].data = data;
      salesTrendChart.update();
      
      // Update status chart
      const statusCounts = {};
      orders.forEach(order => {
        const status = order.status || 'pending';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
      });
      
      const statusLabels = Object.keys(statusCounts);
      const statusData = Object.values(statusCounts);
      
      salesStatusChart.data.labels = statusLabels;
      salesStatusChart.data.datasets[0].data = statusData;
      salesStatusChart.update();
    }

    // Update UI after report generation
    function updateReportUI() {
      // Update stats cards
      document.getElementById('totalRevenue').textContent = formatCurrency(reportSummary.totalRevenue);
      document.getElementById('totalOrders').textContent = reportSummary.totalOrders.toLocaleString();
      document.getElementById('totalCustomers').textContent = reportSummary.totalCustomers.toLocaleString();
      document.getElementById('averageOrder').textContent = formatCurrency(reportSummary.averageOrderValue);
      
      // Update percentage changes (re-calculate based on report period)
      // For simplicity, we'll just show static values here
      // In a real app, you'd compare with previous period
      document.getElementById('revenueChange').textContent = '0%';
      document.getElementById('ordersChange').textContent = '0%';
      document.getElementById('customersChange').textContent = '0%';
      document.getElementById('averageOrderChange').textContent = '0%';
      document.getElementById('refundRateChange').textContent = '0%';
      
      // Update summary section
      document.getElementById('summaryRevenue').textContent = formatCurrency(reportSummary.totalRevenue);
      document.getElementById('summaryOrders').textContent = reportSummary.totalOrders.toLocaleString();
      document.getElementById('summaryCustomers').textContent = reportSummary.totalCustomers.toLocaleString();
      document.getElementById('summaryAverage').textContent = formatCurrency(reportSummary.averageOrderValue);
      
      // Show sections
      document.getElementById('chartsSection').style.display = 'grid';
      document.getElementById('summarySection').style.display = 'block';
      document.getElementById('reportsSection').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      
      // Scroll to results
      document.getElementById('chartsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Update trend chart type
    function updateTrendChart() {
      const chartType = document.getElementById('trendChartType').value;
      salesTrendChart.config.type = chartType;
      salesTrendChart.update();
    }

    // Update status chart type
    function updateStatusChart() {
      const chartType = document.getElementById('statusChartType').value;
      salesStatusChart.config.type = chartType;
      salesStatusChart.update();
    }

    // Export report
    function exportReport(format) {
      if (currentReportData.length === 0) {
        showToast('No data to export. Please generate a report first.', 'warning');
        return;
      }
      
      let filename = '';
      let content = '';
      const dateStr = new Date().toISOString().split('T')[0];
      
      switch(format) {
        case 'csv':
          filename = `sales-report-${dateStr}.csv`;
          content = generateCSV();
          break;
        case 'excel':
          filename = `sales-report-${dateStr}.xlsx`;
          showToast('Excel export would generate here (CSV exported instead)', 'info');
          content = generateCSV(); // Fallback to CSV
          break;
        case 'pdf':
          filename = `sales-report-${dateStr}.pdf`;
          showToast('PDF export would generate here in a real application', 'info');
          return;
      }
      
      if (content) {
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        URL.revokeObjectURL(url);
        
        showToast(`Report exported as ${format.toUpperCase()}`, 'success');
      }
    }

    // Generate CSV content
    function generateCSV() {
      const headers = ['Order ID', 'Date', 'Customer', 'Email', 'Status', 'Items', 'Subtotal', 'Tax', 'Shipping', 'Total'];
      const rows = currentReportData.map(order => {
        const orderItems = order.order_items || [];
        const itemsCount = orderItems.length;
        const itemsTotal = orderItems.reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 1)), 0);
        
        const subtotal = order.subtotal || itemsTotal || order.total * 0.85;
        const tax = order.tax || order.total * 0.10;
        const shipping = order.shipping_cost || order.total * 0.05;
        const total = order.total || subtotal + tax + shipping;
        
        return [
          order.id,
          new Date(order.created_at).toLocaleDateString(),
          order.customer_name || 'Customer',
          order.customer_email || 'N/A',
          order.status || 'pending',
          itemsCount,
          subtotal.toFixed(2),
          tax.toFixed(2),
          shipping.toFixed(2),
          total.toFixed(2)
        ];
      });
      
      // Add summary row
      rows.push(['', '', '', '', 'TOTALS:', 
                reportSummary.totalItems || '-', 
                (reportSummary.totalSubtotal || 0).toFixed(2), 
                (reportSummary.totalTax || 0).toFixed(2), 
                (reportSummary.totalShipping || 0).toFixed(2), 
                (reportSummary.totalRevenue || 0).toFixed(2)]);
      
      return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    // Print report
    function printReport() {
      if (currentReportData.length === 0) {
        showToast('No data to print. Please generate a report first.', 'warning');
        return;
      }
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Sales Report - ${new Date().toLocaleDateString()}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              h1 { color: #333; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f5f5f5; }
              .total-row { font-weight: bold; background-color: #f9f9f9; }
              .summary { margin: 20px 0; padding: 15px; background-color: #f5f5f5; border-radius: 5px; }
            </style>
          </head>
          <body>
            <h1>Sales Report</h1>
            <p>Date Range: ${document.getElementById('fromDate').value} to ${document.getElementById('toDate').value}</p>
            
            <div class="summary">
              <h3>Summary</h3>
              <p>Total Revenue: ${formatCurrency(reportSummary.totalRevenue)}</p>
              <p>Total Orders: ${reportSummary.totalOrders}</p>
              <p>Total Customers: ${reportSummary.totalCustomers}</p>
              <p>Average Order Value: ${formatCurrency(reportSummary.averageOrderValue)}</p>
            </div>
            
            <h3>Order Details</h3>
            ${document.getElementById('reportTable').outerHTML}
            
            <p style="margin-top: 30px; font-size: 12px; color: #666;">
              Generated on ${new Date().toLocaleString()} by ${document.getElementById('userName').textContent}
            </p>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    }

    // Email report
    function emailReport() {
      showToast('Email functionality would be implemented here', 'info');
    }

    // Clear all filters
    function clearFilters() {
      setDefaultDates();
      document.getElementById('reportType').value = 'detailed';
      document.getElementById('statusFilter').value = '';
      document.getElementById('customerFilter').value = '';
      showToast('Filters cleared', 'info');
    }

    // Refresh data
    function refreshData() {
      loadInitialStats();
      showToast('Refreshing sales data...', 'info');
      
      // Show refresh animation
      const refreshBtn = event?.target?.closest('.btn');
      if (refreshBtn) {
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-check"></i> Refreshed!';
        refreshBtn.disabled = true;
        
        setTimeout(() => {
          refreshBtn.innerHTML = originalHTML;
          refreshBtn.disabled = false;
        }, 1500);
      }
    }

    // Show toast message
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }

    // Logout
    async function logout() {
      if (confirm('Are you sure you want to logout?')) {
        await sb.auth.signOut();
        localStorage.removeItem('lastAdminLogin');
        window.location.href = 'admin-login.html?logout=true';
      }
    }
  </script>
</body>
</html>